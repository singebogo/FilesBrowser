<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux æ–‡ä»¶æµè§ˆå™¨</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .toolbar {
            padding: 15px;
            background: #4285f4;
            color: white;
            display: flex;
            align-items: center;
        }
        .path-display {
            flex-grow: 1;
            font-family: monospace;
            padding: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin: 0 15px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #refresh-btn {
            background: #34a853;
            color: white;
            margin-left: 10px;
        }
        #download-btn, #download-btn1{
            background: #ea4335;
            color: white;
            margin-left: 10px;
        }
        #download-btn:disabled, #download-btn1:disabled {
            background: #cccccc;
        }
        .selection-info {
            margin-left: 15px;
            font-size: 0.9em;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .file-item:hover {
            background-color: #f9f9f9;
        }
        .file-checkbox {
            margin-right: 10px;
        }
        .file-icon {
            margin-right: 10px;
            width: 24px;
            text-align: center;
        }
        .dir-icon {
            color: #4285f4;
        }
        .file-name {
            flex-grow: 1;
        }
        .file-size {
            color: #666;
            font-size: 0.9em;
            min-width: 80px;
            text-align: right;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #4285f4;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .loading {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        .hostname{
            margin-right: 5px;
            margin-left: 5px;
        }
        .list-header {
            padding: 8px 16px;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            margin-left: 300px;
            margin-right: 100px;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .file-item {
        padding: 8px 16px;
        border-bottom: 1px solid #eee;
      }

      .file-item:hover {
        background: #f9f9f9;
      }

      .sort-icon {
        margin-left: 8px;
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <button type="button" class="btn btn-secondary" style=" background: #34a853; color: white;"
                    onclick="window.location.href='/manage-ssh'">
              è¿”å›é…ç½®ç®¡ç†
            </button>
            <button id="refresh-btn">åˆ·æ–°</button>
            <button id="download-btn" disabled>ä¸‹è½½é€‰ä¸­æ–‡ä»¶-zipä¸‹è½½</button>
            <span class="selection-info" id="selection-info">æœªé€‰æ‹©æ–‡ä»¶</span>
            <div class="path-display" id="current-path">/</div>
            <div class="hostname" id="hostname">{{config.hostname}}</div>
            <span>è¿æ¥ç”¨æˆ·: {{ config.username }}</span>
        </div>
        <div class="file-list-container">
            <div class="list-header" id="sort-header">æ–‡ä»¶å <span class="sort-icon">â†•</span></div>
            <ul class="file-list" id="file-list">
                <li class="loading">åŠ è½½ä¸­...</li>
            </ul>
        </div>
    </div>

    <div class="modal" id="progress-modal">
        <div class="modal-content">
            <h3>æ–‡ä»¶ä¸‹è½½ä¸­...</h3>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">å‡†å¤‡ä¸‹è½½...</div>
            </div>
            <div id="download-details"></div>
        </div>
    </div>
    <div  class="modal"  id="progress-modal1">
        <div class="modal-content">
            <h3>æ–‡ä»¶æ€»ä½“è¿›åº¦ä¸‹è½½è¿›åº¦</h3>

            <!-- æ€»ä½“è¿›åº¦ -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="overall-progress-text"></div>
            </div>

            <!-- å•ä¸ªæ–‡ä»¶è¿›åº¦å®¹å™¨ -->
            <div id="progress-container"></div>

            <button onclick="$('#progress-modal1').hide()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        let currentPath = '/';
        let selectedFiles = [];


        document.getElementById('sort-header').addEventListener('click', function() {
            const fileList = document.getElementById('file-list');
            const items = Array.from(fileList.getElementsByClassName('file-item'));
            const sortIcon = this.querySelector('.sort-icon');

            // Determine current sort direction
            const ascending = this.getAttribute('data-sort') !== 'asc';

            // Sort items by file name
            items.sort((a, b) => {
              const nameA = a.textContent.toLowerCase();
              const nameB = b.textContent.toLowerCase();
              return ascending
                ? nameA.localeCompare(nameB)
                : nameB.localeCompare(nameA);
            });

            // Reorder items in DOM
            items.forEach(item => fileList.appendChild(item));

            // Update sort state and icon
            this.setAttribute('data-sort', ascending ? 'asc' : 'desc');
            sortIcon.textContent = ascending ? 'â†‘' : 'â†“';
        });

        function selectConfig(name) {
            window.location.href = '/select-config/' + encodeURIComponent(name);
        }
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${units[i]}`;
        }

        // åŠ è½½ç›®å½•å†…å®¹
        function loadDirectory(path) {
            currentPath = path;
            $('#file-list').html('<li class="loading">åŠ è½½ä¸­...</li>');
            $('#current-path').text(path);

            $.ajax({
                url: '/list',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ path: path }),
                success: function(response) {
                    if (response.success) {
                        renderFiles(response.files);
                    } else {
                        showError(response.error);
                    }
                },
                error: function(xhr) {
                    showError(xhr.statusText);
                }
            });
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFiles(files) {
            $('#file-list').empty();

            // æ·»åŠ è¿”å›ä¸Šçº§ç›®å½•é¡¹
            if (currentPath !== '/') {
                const parentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
                $('#file-list').append(`
                    <li class="file-item" data-path="${parentPath}" data-is-dir="true">
                        <div class="file-icon dir-icon">ğŸ“</div>
                        <div class="file-name">..</div>
                        <div class="file-size"></div>
                    </li>
                `);
            }

            // æ·»åŠ æ–‡ä»¶å’Œç›®å½•é¡¹
            files.forEach(file => {
                const icon = file.is_dir ? 'ğŸ“' : 'ğŸ“„';
                const size = file.is_dir ? '' : formatFileSize(file.size);

                $('#file-list').append(`
                    <li class="file-item" data-path="${file.path}" data-is-dir="${file.is_dir}" data-size="${file.size}">
                        <input type="checkbox" class="file-checkbox" ${file.is_dir ? 'disabled' : ''}>
                        <div class="file-icon ${file.is_dir ? 'dir-icon' : ''}">${icon}</div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${size}</div>
                    </li>
                `);
            });

            // ç»‘å®šäº‹ä»¶
            $('.file-checkbox').change(updateSelection);
            $('.file-item').dblclick(function() {
                if ($(this).data('is-dir')) {
                    loadDirectory($(this).data('path'));
                }
            });

            updateSelection();
        }

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        function updateSelection() {
            selectedFiles = [];
            let totalSize = 0;

            $('.file-checkbox:checked').each(function() {
                const item = $(this).closest('.file-item');
                selectedFiles.push({
                    path: item.data('path'),
                    name: item.find('.file-name').text(),
                    size: item.data('size')
                });
                totalSize += item.data('size') || 0;
            });

            // æ›´æ–°UI
            const count = selectedFiles.length;
            $('#download-btn').prop('disabled', count === 0);
            $('#download-btn1').prop('disabled', count === 0);
            $('#selection-info').text(
                count ? `å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶ (${formatFileSize(totalSize)})` : 'æœªé€‰æ‹©æ–‡ä»¶'
            );
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            $('#file-list').html(`
                <li class="loading" style="color: red">
                    é”™è¯¯: ${message}<br>
                    <button onclick="loadDirectory('/')">è¿”å›æ ¹ç›®å½•</button>
                </li>
            `);
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFiles() {
            if (selectedFiles.length === 0) return;

            // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
            $('#progress-modal').show();
            $('#progress-fill').css('width', '0%');
            $('#progress-text').text('å‡†å¤‡ä¸‹è½½...');

            // ä½¿ç”¨XMLHttpRequestæ›¿ä»£fetchä»¥è·å¾—æ›´å¥½çš„è¿›åº¦æ”¯æŒ
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/download', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.responseType = 'blob';

            // è¿›åº¦æ›´æ–°
            xhr.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    $('#progress-fill').css('width', percent + '%');
                    $('#progress-text').text(`ä¸‹è½½ä¸­ ${percent}%`);
                }
            };

            xhr.onload = function() {
                if (this.status === 200) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = this.response;
                    const url = window.URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'downloaded_files.zip';
                    document.body.appendChild(a);
                    a.click();

                    // æ¸…ç†
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // æ›´æ–°UI
                    $('#progress-fill').css('width', '100%');
                    $('#progress-text').text('ä¸‹è½½å®Œæˆï¼');

                    setTimeout(() => {
                        $('#progress-modal').hide();
                    }, 2000);
                } else {
                    $('#progress-text').text('ä¸‹è½½å¤±è´¥: ' + this.statusText);
                }
            };

            xhr.onerror = function() {
                $('#progress-text').text('ç½‘ç»œé”™è¯¯');
            };

            // å‘é€è¯·æ±‚
            xhr.send(JSON.stringify({
                files: selectedFiles.map(f => f.path)
            }));
        }

        function downloadEachFiles() {
            if (selectedFiles.length === 0) return;

            // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
            $('#progress-modal1').show();
            $('#progress-container').empty(); // æ¸…ç©ºä¹‹å‰çš„è¿›åº¦æ¡
            $('#overall-progress-fill').css('width', '0%');
            $('#overall-progress-text').text('å‡†å¤‡ä¸‹è½½...');

            // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºè¿›åº¦æ¡
            selectedFiles.forEach((file, index) => {
                $('#progress-container').append(`
                    <div class="file-download-item">
                        <div class="filename">${file.name}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="file-${index}-progress" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="file-${index}-text">ç­‰å¾…ä¸‹è½½</div>
                        <div class="file-size" id="file-${index}-size">-</div>
                    </div>
                `);
            });


            // ä½¿ç”¨fetch APIè·å–æ–‡ä»¶åˆ—è¡¨
            fetch('/download_items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    files: selectedFiles.map(f => f.path)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'ä¸‹è½½å¤±è´¥');
                }

                let completedCount = 0;
                const totalFiles = data.files.length;

                // æ›´æ–°æ€»è¿›åº¦
                function updateOverallProgress() {
                    const percent = Math.round((completedCount / totalFiles) * 100);
                    $('#overall-progress-fill').css('width', percent + '%');
                    $('#overall-progress-text').text(`å·²å®Œæˆ ${completedCount}/${totalFiles} ä¸ªæ–‡ä»¶`);

                    if (completedCount === totalFiles) {
                        $('#overall-progress-text').text('æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆï¼');
                        setTimeout(() => $('#progress-modal1').hide(), 3000);
                    }
                }

                // é€ä¸ªä¸‹è½½æ–‡ä»¶
                data.files.forEach((file, index) => {
                    $(`#file-${index}-size`).text(formatFileSize(file.size));
                    $(`#file-${index}-text`).text('å‡†å¤‡ä¸‹è½½...');

                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', file.download_url, true);
                    xhr.responseType = 'blob';

                    xhr.onprogress = function(e) {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            $(`#file-${index}-progress`).css('width', percent + '%');
                            $(`#file-${index}-text`).text(`ä¸‹è½½ä¸­ ${percent}%`);
                        }
                    };

                    xhr.onload = function() {
                        if (this.status === 200) {
                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const blob = this.response;
                            const url = window.URL.createObjectURL(blob);

                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = file.filename;
                            document.body.appendChild(a);
                            a.click();

                            // æ¸…ç†
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);

                            // æ›´æ–°UI
                            $(`#file-${index}-progress`).css('width', '100%');
                            $(`#file-${index}-text`).text('ä¸‹è½½å®Œæˆ');

                            completedCount++;
                            updateOverallProgress();
                        } else {
                            $(`#file-${index}-text`).text('ä¸‹è½½å¤±è´¥');
                            completedCount++;
                            updateOverallProgress();
                        }
                    };

                    xhr.onerror = function() {
                        $(`#file-${index}-text`).text('ç½‘ç»œé”™è¯¯');
                        completedCount++;
                        updateOverallProgress();
                    };

                    xhr.send();
                });
            })
            .catch(error => {
                $('#overall-progress-text').text('é”™è¯¯: ' + error.message);
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        $(document).ready(function() {
            $('#refresh-btn').click(() => loadDirectory(currentPath));
            $('#download-btn').click(downloadFiles);
            $('#download-btn1').click(downloadEachFiles);

            // åˆå§‹åŠ è½½æ ¹ç›®å½•
            loadDirectory('/');
        });
    </script>
</body>
</html>